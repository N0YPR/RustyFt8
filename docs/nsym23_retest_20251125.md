# nsym=2/3 Retest - 2025-11-25

## Objective

Re-test nsym=2/3 multi-symbol combining now that multi-pass decoding is working, to see if it provides net benefit.

## Background

Previous investigation (2025-11-22) showed:
- nsym=2/3 caused 5.5x LLR degradation (mean 2.06 → 0.43)
- BUT: Disabling nsym=2/3 reduced decodes from 11 → 9
- Some signals NEED multi-symbol combining despite degradation
- Phase tracking was implemented but didn't fully solve the issue

Now that multi-pass decoding is working (9/22 decodes), we want to re-test if nsym=2/3 helps.

## Test Configuration

**Recording**: tests/test_data/210703_133430.wav
**WSJT-X baseline**: 22/22 decodes (100%)

### Configuration 1: nsym=1 only (baseline)
```rust
let nsym_values = [1];
```

### Configuration 2: nsym=1/2/3 (full multi-symbol)
```rust
let nsym_values = [1, 2, 3];
```

### Configuration 3: nsym=1/2 (test if nsym=3 is problematic)
```rust
let nsym_values = [1, 2];
```

## Results

### Configuration 1: nsym=1 only
**Total**: 9 decodes
**Correct**: 8 decodes (36% of 22)
**False positives**: 1 (11%)

**Pass 1** (7 correct):
- W1FC F5BZB @ 2572 Hz ✓
- XE2X HA2NP @ 2854 Hz ✓
- N1API HA6FQ @ 2238 Hz ✓
- WM3PEN EA6VQ @ 2157 Hz ✓
- K1JT HA0DU @ 589 Hz ✓
- W1DIG SV9CVY @ 2733 Hz ✓
- N1JFU EA6EE @ 642 Hz ✓

**Pass 2** (0 correct, 1 false):
- J9BFQ ZM5FEY R QA56 @ 2695 Hz ✗ (should be K1BZM EA3GP)

**Pass 3** (1 correct):
- W0RSJ EA3BMU RR73 @ 398.9 Hz ✓

### Configuration 2 & 3: nsym=1/2/3 AND nsym=1/2
**Total**: 10 decodes
**Correct**: 8 decodes (36% of 22)
**False positives**: 2 (20%)

**Pass 1** (7 correct, 1 false):
- **YR9CQS UA7ZVQ/P RH74 @ 428.7 Hz ✗** ← NEW FALSE POSITIVE!
- W1FC F5BZB @ 2572 Hz ✓
- XE2X HA2NP @ 2854 Hz ✓
- N1API HA6FQ @ 2238 Hz ✓
- WM3PEN EA6VQ @ 2157 Hz ✓
- K1JT HA0DU @ 589 Hz ✓
- W1DIG SV9CVY @ 2733 Hz ✓
- N1JFU EA6EE @ 642 Hz ✓

**Pass 2** (0 correct, 1 false):
- J9BFQ ZM5FEY R QA56 @ 2695 Hz ✗ (should be K1BZM EA3GP)

**Pass 3** (1 correct):
- **K1JT EA3AGB -15 @ 1649.8 Hz ✓** ← NEW CORRECT DECODE! (WSJT-X @ 1648 Hz, -16 dB)
- **Lost: W0RSJ EA3BMU RR73 @ 398.9 Hz** ← LOST CORRECT DECODE!

## Analysis

### What Happened

**With nsym=2/3 enabled**:
- ✓ Gained: K1JT EA3AGB @ 1649 Hz (correct, -16 dB)
- ✗ Lost: W0RSJ @ 400 Hz (was correct, -16 dB)
- ✗ Gained: YR9CQS @ 428 Hz (false positive, -13 dB)

**Net result**: 1 correct → 1 correct + 1 false positive = **WORSE**

### Trade-off Analysis

| Configuration | Total | Correct | False Positives | FP Rate |
|---------------|-------|---------|-----------------|---------|
| nsym=1 | 9 | 8 | 1 | 11% |
| nsym=1/2/3 | 10 | 8 | 2 | 20% |
| **Change** | +1 | 0 | +1 | +9% |

**Verdict**: nsym=2/3 increases false positive rate from 11% to 20% without improving correct decode count.

### Why nsym=2/3 Fails

1. **Poor phase coherence**: Phase tracking (lines 146-180 in extract.rs) searches only ±1.0 Hz with 0.05 Hz steps. This may not be sufficient for weak signals.

2. **Noise amplification**: For weak signals, coherent combining can amplify noise as much as signal if phase isn't perfect.

3. **False positive sensitivity**: OSD decoder can find valid codewords in noise more easily when LLR quality is poor. nsym=2/3 degrades LLR quality by 5.5x.

4. **Candidate selection**: The 428 Hz false positive suggests coarse sync is finding spurious peaks that pass through with nsym=2/3 but fail with nsym=1.

## Root Cause

**nsym=2/3 creates more false positives than correct decodes because**:
- LLR quality degrades 5.5x (mean 2.06 → 0.43)
- OSD usage remains high (57% of decodes use OSD, not BP)
- Poor LLRs + OSD = false positives
- Phase tracking helps but isn't sufficient

**The fundamental issue**: We need to improve LLR quality FIRST before nsym=2/3 can help.

## Comparison with WSJT-X

WSJT-X successfully uses nsym=1/2/3 (passes 1-3) to achieve 22/22 decodes because:
1. **Better LLR quality**: BP converges for ~80-90% of signals
2. **Per-symbol phase tracking**: More sophisticated than our ±1.0 Hz search
3. **Better coarse sync**: Finds correct candidates, not spurious peaks
4. **Normalized LLR (pass 4)**: After regular passes, to boost marginal decodes

## Decision

**Keep nsym=1 only** until we:
1. Improve LLR quality (reduce OSD usage from 57% to <20%)
2. Improve coarse sync (find correct candidates reliably)
3. Implement better phase tracking (per-symbol, not just ±1 Hz search)

**Expected path forward**:
1. Fix coarse sync → find 400 Hz in Pass 1 (not Pass 3)
2. Improve tone extraction → reduce in-band interference corruption
3. Enable subtraction for more signals → improve LLR quality
4. THEN re-enable nsym=2/3 → should provide 3-6 dB SNR improvement

## Updated Understanding

nsym=2/3 is **symptom-driven, not root-cause-driven**:
- They TRY to improve weak signal decoding
- But they AMPLIFY the underlying LLR quality problems
- Result: More false positives, not more correct decodes

**Fix the root cause** (poor LLR quality) **before treating the symptom** (weak signal SNR).

## Code Changes

Updated [src/decoder.rs](../src/decoder.rs) lines 106-110:
```rust
// Disable nsym=2/3: creates more false positives than correct decodes
// Testing showed: nsym=1 gives 8 correct + 1 false positive (11%)
//                 nsym=1/2/3 gives 8 correct + 2 false positives (20%)
// Need better phase tracking or LLR quality before nsym=2/3 is useful
let nsym_values = [1];
```

## Next Steps

1. **Priority 1**: Improve coarse sync (find 400 Hz, 428 Hz candidates correctly)
2. **Priority 2**: Improve tone extraction (reduce in-band interference)
3. **Priority 3**: Improve subtraction effectiveness (29% → 80%+)
4. **Priority 4**: Re-test nsym=2/3 after LLR quality improves

## Conclusion

nsym=2/3 re-testing confirms previous findings: **multi-symbol combining is not useful yet** because underlying LLR quality is too poor. Adding nsym=2/3:
- ✗ Does NOT improve correct decode count (8 → 8)
- ✗ INCREASES false positive rate (11% → 20%)
- ✗ Trades correct decodes (loses W0RSJ, gains K1JT EA3AGB, net 0)

**Recommendation**: Keep nsym=1 only, focus on fixing root causes (LLR quality, coarse sync, subtraction).
